import fs from 'fs-extra';
import * as path from 'path';
import * as os from 'os';
import chalk from 'chalk';
import { execSync } from 'child_process';

/**
 * Setup Claude Code for the Web (CCW) integration
 * Idempotent - can run multiple times to update
 */
export async function setupCCW(projectRoot: string = process.cwd()): Promise<void> {
  console.log(chalk.bold.cyan('\nüîß Setting up Claude Code for the Web (CCW)\n'));

  const ccwDir = path.join(projectRoot, '.claude-code');
  const mcpHelpersDir = path.join(ccwDir, 'mcp-helpers');
  const workflowsDir = path.join(ccwDir, 'workflows');

  // 1. Copy global CLAUDE.md
  await copyGlobalClaudeMd(ccwDir);

  // 2. Copy Claude commands
  await copyClaudeCommands(workflowsDir);

  // 3. Create MCP setup script
  await createMCPSetupScript(mcpHelpersDir);

  // 4. Update project CLAUDE.md with link
  await updateProjectClaudeMd(projectRoot);

  // 5. Update .gitignore
  await updateGitignore(projectRoot);

  // 6. Detect and output required tokens
  const requiredTokens = await detectRequiredTokens(projectRoot);
  outputTokenList(requiredTokens);

  // 7. Output first CCW prompt
  outputFirstPrompt();

  console.log(chalk.green('\n‚úÖ CCW setup complete!\n'));
}

/**
 * Copy ~/.claude/CLAUDE.md to .claude-code/GLOBAL_CLAUDE.md
 */
async function copyGlobalClaudeMd(ccwDir: string): Promise<void> {
  const globalClaudePath = path.join(os.homedir(), '.claude', 'CLAUDE.md');
  const targetPath = path.join(ccwDir, 'GLOBAL_CLAUDE.md');

  if (!await fs.pathExists(globalClaudePath)) {
    console.log(chalk.yellow('‚ö†Ô∏è  ~/.claude/CLAUDE.md not found - skipping global rules'));
    return;
  }

  await fs.ensureDir(ccwDir);
  await fs.copy(globalClaudePath, targetPath);
  console.log(chalk.green('‚úÖ Copied ~/.claude/CLAUDE.md ‚Üí .claude-code/GLOBAL_CLAUDE.md'));
}

/**
 * Copy all files from ~/.claude/commands/ to .claude-code/workflows/
 */
async function copyClaudeCommands(workflowsDir: string): Promise<void> {
  const commandsPath = path.join(os.homedir(), '.claude', 'commands');

  if (!await fs.pathExists(commandsPath)) {
    console.log(chalk.yellow('‚ö†Ô∏è  ~/.claude/commands/ not found - skipping command workflows'));
    return;
  }

  await fs.ensureDir(workflowsDir);

  const files = await fs.readdir(commandsPath);
  let copiedCount = 0;

  for (const file of files) {
    if (file.endsWith('.md')) {
      const sourcePath = path.join(commandsPath, file);
      const targetPath = path.join(workflowsDir, file);
      await fs.copy(sourcePath, targetPath);
      copiedCount++;
    }
  }

  console.log(chalk.green(`‚úÖ Copied ${copiedCount} Claude commands ‚Üí .claude-code/workflows/`));
}

/**
 * Create .claude-code/mcp-helpers/setup.sh
 */
async function createMCPSetupScript(mcpHelpersDir: string): Promise<void> {
  await fs.ensureDir(mcpHelpersDir);

  const setupScript = `#!/bin/bash
# Auto-generated by deploy-kit ccw
# Setup MCP servers for Claude Code for the Web

set -e

echo "üîß Setting up MCP servers for CCW..."

# Install jq (JSON processor)
echo "üì¶ Installing jq..."
command -v jq >/dev/null 2>&1 || {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    brew install jq
  else
    apt-get update && apt-get install -y jq
  fi
}

# Install GitHub CLI
echo "üì¶ Installing GitHub CLI..."
command -v gh >/dev/null 2>&1 || {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    brew install gh
  else
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    apt update && apt install gh
  fi
}

# Authenticate GitHub CLI
if [ -n "$GITHUB_TOKEN" ]; then
  echo "$GITHUB_TOKEN" | gh auth login --with-token
  echo "‚úÖ GitHub CLI authenticated"
else
  echo "‚ö†Ô∏è  GITHUB_TOKEN not set - GitHub operations will fail"
fi

# Install MCP servers
echo "üì¶ Installing MCP servers..."
npm install -g @modelcontextprotocol/server-playwright
npm install -g @context7/mcp-server
npm install -g @modelcontextprotocol/server-linear

# Verify Linear API key
if [ -n "$LINEAR_API_KEY" ]; then
  echo "‚úÖ LINEAR_API_KEY detected"
else
  echo "‚ö†Ô∏è  LINEAR_API_KEY not set - Linear operations will fail"
fi

# Verify npm token
if [ -n "$NPM_TOKEN" ]; then
  echo "‚úÖ NPM_TOKEN detected"
else
  echo "‚ö†Ô∏è  NPM_TOKEN not set - npm publish will fail"
fi

echo ""
echo "‚úÖ MCP setup complete!"
echo ""
echo "MCP servers installed:"
echo "  - Playwright (browser automation)"
echo "  - Context7 (library documentation)"
echo "  - Linear (issue tracking)"
`;

  const setupPath = path.join(mcpHelpersDir, 'setup.sh');
  await fs.writeFile(setupPath, setupScript);
  await fs.chmod(setupPath, 0o755);

  console.log(chalk.green('‚úÖ Created .claude-code/mcp-helpers/setup.sh'));
}

/**
 * Update project CLAUDE.md with link to global rules
 */
async function updateProjectClaudeMd(projectRoot: string): Promise<void> {
  const claudeMdPath = path.join(projectRoot, 'CLAUDE.md');

  if (!await fs.pathExists(claudeMdPath)) {
    console.log(chalk.yellow('‚ö†Ô∏è  CLAUDE.md not found - skipping update'));
    return;
  }

  let content = await fs.readFile(claudeMdPath, 'utf-8');

  // Check if link already exists
  if (content.includes('.claude-code/GLOBAL_CLAUDE.md')) {
    console.log(chalk.gray('   CLAUDE.md already has link to global rules'));
    return;
  }

  // Add link after title
  const lines = content.split('\n');
  const titleIndex = lines.findIndex((line: string) => line.startsWith('#'));

  if (titleIndex !== -1) {
    lines.splice(titleIndex + 1, 0, '',
      '**IMPORTANT:** See `.claude-code/GLOBAL_CLAUDE.md` for universal rules that apply to ALL projects.',
      ''
    );

    content = lines.join('\n');
    await fs.writeFile(claudeMdPath, content);
    console.log(chalk.green('‚úÖ Updated ./CLAUDE.md with link to global rules'));
  }
}

/**
 * Update .gitignore
 */
async function updateGitignore(projectRoot: string): Promise<void> {
  const gitignorePath = path.join(projectRoot, '.gitignore');

  if (!await fs.pathExists(gitignorePath)) {
    console.log(chalk.yellow('‚ö†Ô∏è  .gitignore not found - skipping update'));
    return;
  }

  let content = await fs.readFile(gitignorePath, 'utf-8');

  const rules = [
    '.claude-code/*_TOKENS*',
    '.claude-code/.env*'
  ];

  let added = false;
  for (const rule of rules) {
    if (!content.includes(rule)) {
      content += `\n${rule}`;
      added = true;
    }
  }

  if (added) {
    await fs.writeFile(gitignorePath, content);
    console.log(chalk.green('‚úÖ Added .gitignore rules'));
  } else {
    console.log(chalk.gray('   .gitignore already has CCW rules'));
  }
}

/**
 * Detect which tokens are required
 */
async function detectRequiredTokens(projectRoot: string): Promise<string[]> {
  const tokens: string[] = ['GITHUB_TOKEN', 'LINEAR_API_KEY'];

  // Check if npm package (needs NPM_TOKEN)
  const packageJsonPath = path.join(projectRoot, 'package.json');
  if (await fs.pathExists(packageJsonPath)) {
    const packageJson = await fs.readJson(packageJsonPath);
    if (packageJson.publishConfig || packageJson.name?.startsWith('@')) {
      tokens.push('NPM_TOKEN');
    }
  }

  return tokens;
}

/**
 * Output list of required tokens
 */
function outputTokenList(tokens: string[]): void {
  console.log('\nRequired CCW environment variables:');
  console.log(chalk.gray('‚îÅ'.repeat(60)));

  for (const token of tokens) {
    const hint = getTokenHint(token);
    console.log(`${chalk.cyan(token.padEnd(25))} ${chalk.gray(hint)}`);
  }

  console.log(chalk.gray('‚îÅ'.repeat(60)));
  console.log(chalk.yellow('\nNote: For deployments, use Desktop Claude Code or GitHub Actions.'));
  console.log(chalk.yellow('      CCW is for feature development, refactoring, and testing only.'));
}

/**
 * Get hint for where to find token
 */
function getTokenHint(token: string): string {
  switch (token) {
    case 'GITHUB_TOKEN':
      return '(gh auth token)';
    case 'LINEAR_API_KEY':
      return '(https://linear.app/settings/api)';
    case 'NPM_TOKEN':
      return '(cat ~/.npmrc | grep _authToken)';
    default:
      return '';
  }
}

/**
 * Output first CCW prompt
 */
function outputFirstPrompt(): void {
  console.log('\nCopy this to CCW as your first message:');
  console.log(chalk.gray('‚îÅ'.repeat(60)));
  console.log(chalk.white(`
First, set up the development environment by installing MCP servers
(Playwright, Context7, Linear) and authenticating with GitHub/npm/Linear:

source .claude-code/mcp-helpers/setup.sh

Now I'm ready to work on: [DESCRIBE YOUR TASK]
`));
  console.log(chalk.gray('‚îÅ'.repeat(60)));
}
