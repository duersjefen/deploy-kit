import fs from 'fs-extra';
import * as path from 'path';
import * as os from 'os';
import chalk from 'chalk';
/**
 * Setup Claude Code for the Web (CCW) integration
 * Idempotent - can run multiple times to update
 *
 * Follows official CCW best practices:
 * - Uses .claude/ directory (official location)
 * - Creates .claude/settings.json with SessionStart hooks
 * - Auto-installs dependencies on session start
 * - Uses CLAUDE_CODE_REMOTE detection
 * - Uses @ sourcing pattern in CLAUDE.md
 */
export async function setupCCW(projectRoot = process.cwd()) {
    console.log(chalk.bold.cyan('\nüîß Setting up Claude Code for the Web (CCW)\n'));
    const claudeDir = path.join(projectRoot, '.claude');
    const scriptsDir = path.join(projectRoot, 'scripts');
    const workflowsDir = path.join(claudeDir, 'workflows');
    // 1. Copy global CLAUDE.md to .claude/
    await copyGlobalClaudeMd(claudeDir);
    // 2. Copy Claude commands to .claude/workflows/
    await copyClaudeCommands(workflowsDir);
    // 3. Create SessionStart hook script
    await createSessionStartScript(scriptsDir);
    // 4. Create .claude/settings.json with hooks
    await createSettingsJson(claudeDir, scriptsDir);
    // 5. Update project CLAUDE.md with @ sourcing
    await updateProjectClaudeMd(projectRoot, claudeDir);
    // 6. Detect and output required tokens
    const requiredTokens = await detectRequiredTokens(projectRoot);
    outputTokenList(requiredTokens);
    // 7. Output CCW usage instructions
    outputUsageInstructions();
    console.log(chalk.green('\n‚úÖ CCW setup complete!\n'));
}
/**
 * Copy ~/.claude/CLAUDE.md to .claude/GLOBAL_CLAUDE.md
 */
async function copyGlobalClaudeMd(claudeDir) {
    const globalClaudePath = path.join(os.homedir(), '.claude', 'CLAUDE.md');
    const targetPath = path.join(claudeDir, 'GLOBAL_CLAUDE.md');
    if (!await fs.pathExists(globalClaudePath)) {
        console.log(chalk.yellow('‚ö†Ô∏è  ~/.claude/CLAUDE.md not found - skipping global rules'));
        return;
    }
    await fs.ensureDir(claudeDir);
    await fs.copy(globalClaudePath, targetPath);
    console.log(chalk.green('‚úÖ Copied ~/.claude/CLAUDE.md ‚Üí .claude/GLOBAL_CLAUDE.md'));
}
/**
 * Copy all files from ~/.claude/commands/ to .claude/workflows/
 */
async function copyClaudeCommands(workflowsDir) {
    const commandsPath = path.join(os.homedir(), '.claude', 'commands');
    if (!await fs.pathExists(commandsPath)) {
        console.log(chalk.yellow('‚ö†Ô∏è  ~/.claude/commands/ not found - skipping command workflows'));
        return;
    }
    await fs.ensureDir(workflowsDir);
    const files = await fs.readdir(commandsPath);
    let copiedCount = 0;
    for (const file of files) {
        if (file.endsWith('.md')) {
            const sourcePath = path.join(commandsPath, file);
            const targetPath = path.join(workflowsDir, file);
            await fs.copy(sourcePath, targetPath);
            copiedCount++;
        }
    }
    console.log(chalk.green(`‚úÖ Copied ${copiedCount} Claude commands ‚Üí .claude/workflows/`));
}
/**
 * Create scripts/setup_ccw.sh with SessionStart hook logic
 * This runs automatically when CCW session starts
 */
async function createSessionStartScript(scriptsDir) {
    await fs.ensureDir(scriptsDir);
    const setupScript = `#!/bin/bash
# Auto-generated by deploy-kit ccw
# SessionStart hook for Claude Code for the Web
# Runs automatically when CCW session starts

# Only run in CCW cloud environment (not locally)
if [ "$CLAUDE_CODE_REMOTE" != "true" ]; then
  echo "‚ÑπÔ∏è  Skipping CCW setup (running locally)"
  exit 0
fi

set -e

echo "üîß Setting up Claude Code for the Web environment..."

# Install jq if needed (JSON processor)
if ! command -v jq &> /dev/null; then
  echo "üì¶ Installing jq..."
  apt-get update && apt-get install -y jq
fi

# Install GitHub CLI if needed
if ! command -v gh &> /dev/null; then
  echo "üì¶ Installing GitHub CLI..."
  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
  apt-get update && apt-get install -y gh
fi

# Authenticate GitHub CLI if token available
if [ -n "$GITHUB_TOKEN" ]; then
  echo "$GITHUB_TOKEN" | gh auth login --with-token 2>/dev/null
  echo "‚úÖ GitHub CLI authenticated"
else
  echo "‚ö†Ô∏è  GITHUB_TOKEN not set - GitHub operations will fail"
fi

# Install MCP servers globally
echo "üì¶ Installing MCP servers..."
npm install -g @modelcontextprotocol/server-playwright 2>/dev/null
npm install -g @context7/mcp-server 2>/dev/null
npm install -g @modelcontextprotocol/server-linear 2>/dev/null

# Install project dependencies (package.json if exists)
if [ -f "$CLAUDE_PROJECT_DIR/package.json" ]; then
  echo "üì¶ Installing project dependencies..."
  cd "$CLAUDE_PROJECT_DIR"

  # Detect package manager
  if [ -f "pnpm-lock.yaml" ]; then
    pnpm install
  elif [ -f "yarn.lock" ]; then
    yarn install
  elif [ -f "bun.lockb" ]; then
    bun install
  else
    npm install
  fi
fi

# Install Python dependencies if requirements.txt exists
if [ -f "$CLAUDE_PROJECT_DIR/requirements.txt" ]; then
  echo "üì¶ Installing Python dependencies..."
  pip install -r "$CLAUDE_PROJECT_DIR/requirements.txt"
fi

# Persist environment variables for session (if CLAUDE_ENV_FILE is set)
if [ -n "$CLAUDE_ENV_FILE" ]; then
  # Write npm token to npmrc if NPM_TOKEN is set
  if [ -n "$NPM_TOKEN" ]; then
    echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
    echo "NPM_CONFIGURED=true" >> "$CLAUDE_ENV_FILE"
  fi
fi

echo ""
echo "‚úÖ CCW environment ready!"
echo ""
echo "Environment:"
echo "  ‚úÖ MCP servers installed (Playwright, Context7, Linear)"
echo "  ‚úÖ GitHub CLI configured"
if [ -n "$LINEAR_API_KEY" ]; then
  echo "  ‚úÖ Linear API key detected"
fi
if [ -n "$NPM_TOKEN" ]; then
  echo "  ‚úÖ npm token configured"
fi

exit 0
`;
    const setupPath = path.join(scriptsDir, 'setup_ccw.sh');
    await fs.writeFile(setupPath, setupScript);
    await fs.chmod(setupPath, 0o755);
    console.log(chalk.green('‚úÖ Created scripts/setup_ccw.sh (SessionStart hook)'));
}
/**
 * Create .claude/settings.json with SessionStart hooks
 * Uses $CLAUDE_PROJECT_DIR for portability
 */
async function createSettingsJson(claudeDir, scriptsDir) {
    await fs.ensureDir(claudeDir);
    const settings = {
        hooks: {
            SessionStart: [
                {
                    matcher: 'startup',
                    hooks: [
                        {
                            type: 'command',
                            command: '"$CLAUDE_PROJECT_DIR/scripts/setup_ccw.sh"',
                        },
                    ],
                },
            ],
        },
    };
    const settingsPath = path.join(claudeDir, 'settings.json');
    await fs.writeFile(settingsPath, JSON.stringify(settings, null, 2));
    console.log(chalk.green('‚úÖ Created .claude/settings.json (auto-runs setup on session start)'));
}
/**
 * Update project CLAUDE.md with @ sourcing pattern
 * Uses official CCW best practice: @.claude/GLOBAL_CLAUDE.md
 */
async function updateProjectClaudeMd(projectRoot, claudeDir) {
    const claudeMdPath = path.join(projectRoot, 'CLAUDE.md');
    if (!await fs.pathExists(claudeMdPath)) {
        console.log(chalk.yellow('‚ö†Ô∏è  CLAUDE.md not found - skipping update'));
        return;
    }
    let content = await fs.readFile(claudeMdPath, 'utf-8');
    // Check if sourcing already exists
    if (content.includes('@.claude/GLOBAL_CLAUDE.md') || content.includes('.claude/GLOBAL_CLAUDE.md')) {
        console.log(chalk.gray('   CLAUDE.md already sources global rules'));
        return;
    }
    // Add @ sourcing after title (official CCW pattern)
    const lines = content.split('\n');
    const titleIndex = lines.findIndex((line) => line.startsWith('#'));
    if (titleIndex !== -1) {
        lines.splice(titleIndex + 1, 0, '', '**IMPORTANT:** See @.claude/GLOBAL_CLAUDE.md for universal rules that apply to ALL projects.', '');
        content = lines.join('\n');
        await fs.writeFile(claudeMdPath, content);
        console.log(chalk.green('‚úÖ Updated ./CLAUDE.md with @ sourcing pattern'));
    }
}
/**
 * Update .gitignore
 * No longer needed - we don't create token files
 */
async function updateGitignore(projectRoot) {
    // No-op - keeping for backward compatibility
    // All files in .claude-code/ are safe to commit
    console.log(chalk.gray('   .gitignore update not needed (no token files created)'));
}
/**
 * Detect which tokens are required
 */
async function detectRequiredTokens(projectRoot) {
    const tokens = ['GITHUB_TOKEN', 'LINEAR_API_KEY'];
    // Check if npm package (needs NPM_TOKEN)
    const packageJsonPath = path.join(projectRoot, 'package.json');
    if (await fs.pathExists(packageJsonPath)) {
        const packageJson = await fs.readJson(packageJsonPath);
        if (packageJson.publishConfig || packageJson.name?.startsWith('@')) {
            tokens.push('NPM_TOKEN');
        }
    }
    return tokens;
}
/**
 * Output list of required tokens
 */
function outputTokenList(tokens) {
    console.log('\nRequired CCW environment variables:');
    console.log(chalk.gray('‚îÅ'.repeat(60)));
    for (const token of tokens) {
        const hint = getTokenHint(token);
        console.log(`${chalk.cyan(token.padEnd(25))} ${chalk.gray(hint)}`);
    }
    console.log(chalk.gray('‚îÅ'.repeat(60)));
    console.log(chalk.yellow('\nNote: For deployments, use Desktop Claude Code or GitHub Actions.'));
    console.log(chalk.yellow('      CCW is for feature development, refactoring, and testing only.'));
}
/**
 * Get hint for where to find token
 */
function getTokenHint(token) {
    switch (token) {
        case 'GITHUB_TOKEN':
            return '(gh auth token)';
        case 'LINEAR_API_KEY':
            return '(https://linear.app/settings/api)';
        case 'NPM_TOKEN':
            return '(cat ~/.npmrc | grep _authToken)';
        default:
            return '';
    }
}
/**
 * Output CCW usage instructions
 */
function outputUsageInstructions() {
    console.log('\nHow to use CCW:');
    console.log(chalk.gray('‚îÅ'.repeat(60)));
    console.log(chalk.white(`
1. Go to claude.ai/code
2. Connect your GitHub account
3. Set environment variables in CCW:
   - GITHUB_TOKEN (required)
   - LINEAR_API_KEY (if using Linear)
   - NPM_TOKEN (if publishing packages)

4. Select this repository
5. Start your task - setup runs automatically!

The SessionStart hook will:
  ‚úÖ Auto-install MCP servers (Playwright, Context7, Linear)
  ‚úÖ Auto-authenticate GitHub CLI
  ‚úÖ Auto-install project dependencies
  ‚úÖ Configure npm for publishing

No manual setup needed - just start coding!
`));
    console.log(chalk.gray('‚îÅ'.repeat(60)));
}
